<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn Hàng Của Tôi - Elden Fruits</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/cart.css">
    <style>
        /* CSS riêng cho trang đơn hàng */
        .order-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
            border-left: 5px solid #ddd;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .order-status {
            font-weight: bold;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 12px;
            color: white;
            font-size: 12px;
        }

        .bg-warning {
            background: orange;
        }

        .bg-info {
            background: #2196F3;
        }

        .bg-primary {
            background: #3f51b5;
        }

        .bg-success {
            background: #4CAF50;
        }

        .bg-danger {
            background: #f44336;
        }

        .order-item {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            align-items: center;
        }

        .order-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .btn-action {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }

        .btn-cancel {
            background: #f44336;
        }

        .btn-confirm {
            background: #4CAF50;
        }
    </style>
</head>

<body>

    <div class="header-main">
        <div class="container">
            <a href="index.html" class="logo">Elden <span>Fruits</span></a>
            <div class="header-actions">
                <a href="index.html" style="text-decoration: none; color: #333; margin-right: 20px;">
                    <i class="fas fa-home"></i> Trang chủ
                </a>
                <a href="cart.html" style="text-decoration: none; color: #333;">
                    <i class="fas fa-shopping-basket"></i> Giỏ hàng
                </a>
            </div>
        </div>
    </div>

    <div class="page-header">
        <h1 class="page-title">Lịch Sử Đơn Hàng</h1>
    </div>

    <div class="container">
        <div id="my-orders-list">
        </div>
    </div>

    <script src="js/user-manager.js"></script>
    <script src="js/cart-manager.js"></script>
    <script src="js/order-manager.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            renderMyOrders();
        });

        function renderMyOrders() {
            // 1. Kiểm tra đăng nhập
            const user = UserManager.getCurrentUser();
            if (!user) {
                document.getElementById('my-orders-list').innerHTML = `
                    <div style="text-align:center; padding: 50px;">
                        <h3>Bạn chưa đăng nhập!</h3>
                        <a href="auth.html" class="btn-continue">Đăng nhập để xem đơn hàng</a>
                    </div>`;
                return;
            }

            // 2. Lấy đơn hàng của user này
            const orders = OrderManager.getMyOrders();
            const container = document.getElementById('my-orders-list');

            if (orders.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding: 50px;">
                        <i class="fas fa-box-open" style="font-size: 50px; color: #ccc;"></i>
                        <p>Bạn chưa có đơn hàng nào.</p>
                        <a href="index.html" class="btn-continue">Mua sắm ngay</a>
                    </div>`;
                return;
            }

            // 3. Render danh sách
            container.innerHTML = orders.map(order => {
                // Render danh sách sản phẩm con
                const itemsHtml = order.items.map(item => `
                    <div class="order-item">
                        <img src="${item.image}" alt="${item.name}">
                        <div>
                            <div>${item.name}</div>
                            <small>x${item.quantity}</small>
                        </div>
                    </div>
                `).join('');

                // Xác định nút bấm dựa trên trạng thái
                let actionBtn = '';

                // Nếu đang chờ -> Cho phép Hủy
                if (order.status === 'pending') {
                    actionBtn = `<button class="btn-action btn-cancel" onclick="cancelOrder('${order.id}')">Hủy Đơn</button>`;
                }
                // Nếu đang giao -> Cho phép Xác nhận đã nhận
                else if (order.status === 'shipping') {
                    actionBtn = `<button class="btn-action btn-confirm" onclick="confirmReceived('${order.id}')">Đã Nhận Được Hàng</button>`;
                }
                // Nếu hoàn thành rồi
                else if (order.status === 'completed') {
                    actionBtn = `<span style="color: green;"><i class="fas fa-check-circle"></i> Thành công</span>`;
                }

                // Màu viền trái thay đổi theo trạng thái
                const borderColors = {
                    'pending': 'orange', 'shipping': '#3f51b5', 'completed': 'green', 'cancelled': 'red'
                };

                return `
                    <div class="order-card" style="border-left-color: ${borderColors[order.status] || '#ddd'}">
                        <div class="order-header">
                            <div>
                                <b>#${order.id}</b> | <span style="color: #777;">${order.date}</span>
                            </div>
                            <div class="order-status">
                                ${OrderManager.getBadge(order.status)}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            ${itemsHtml}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 10px;">
                            <div style="font-size: 16px;">
                                Tổng tiền: <b style="color: #d32f2f;">${order.total.toLocaleString()}₫</b>
                            </div>
                            <div>${actionBtn}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Hàm Hủy đơn (Chỉ khi Pending)
        function cancelOrder(id) {
            if (confirm("Bạn có chắc muốn hủy đơn hàng này không?")) {
                OrderManager.updateStatus(id, 'cancelled');
                renderMyOrders(); // Vẽ lại giao diện
            }
        }

        // Hàm Xác nhận đã nhận hàng (Chỉ khi Shipping)
        function confirmReceived(id) {
            if (confirm("Xác nhận bạn đã nhận được hàng và hài lòng?")) {
                OrderManager.updateStatus(id, 'completed');
                renderMyOrders(); // Vẽ lại giao diện
            }
        }
    </script>
</body>

</html>